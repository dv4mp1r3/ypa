## Как это работает (теория)

Весь интерфейс взаимодействия с пользователем (далее UI) построен через веб.
По сути это админ-панель для выполнения некоторых действий и просмотра результатов.
Всего у приложения есть несколько компонентов, которые работают параллельно:
1. UI. Тут пользователь просматривает инфу о том что происходит на данный момент, создает новые задачи и прочее.
2. Сервер очередей (RabbitMQ). Хранилище задач для передачи воркерам. Принимает сообщение от UI и/или воркера и помещает
его в очередь, после этого отдает первому на очереди воркеру.
3. Воркеры. Некоторые количество процессов php, работающих в фоне и обрабатывающие сообщения от сервера очередей. Воркеры
в зависимости от результата обработки сообщения, могут порождать новые сообщения, генерировать уведомления, не
уведомлять сервер очередей об обработке текущего сообщения (например, при выбросе исключения) и т.д.
4. СУБД. Постоянное хранилище, которое носит информативный характер по большей части. Туда помещаются созданные
задачи и наиболее интересная информация, которая была получения в ходе ее (задачи) выполнения.


## Как это работает (практика)

Пользователь в админке создает новую задачу. По сути это запись в таблице с привязкой к файлу.
Файл содержит список доменных имен, разделенных переносом на новую строку, которые будут обработаны в рамках данной задачи.
Задаче присваивается уникальный номер, который передается каждому сообщению в сервер очередей (а далее в воркер),
которое было создано в процессе обработки задачи. Дубли доменных имен из списка удаляются. Далее на каждое доменное имя
генерируется сообщение о том что нужно чекнуть этот домен на доступность (команда host). Каждое такое сообщение помещается
в очередь.

Как описывалось ранее, все сообщения обрабатываются воркерами. Всего есть несколько типов воркеров (а точнее логических нагрузок)
в зависимости от того, к какой очереди они подключаются. Расположены они в каталоге `models/payloads`. Все нагрузки являются
потомком класса `models/payloads/AbstractPayload.php`, который обязывает перегрузить метод `execute()`, в котором должна 
быть описана логика обработки сообщения.
В данный момент речь идет о нагрузке `models/payloads/TaskProcessor.php`. Как можно увидеть по коду, в зависимости
от того, какая команда указана в сообщении, TaskProcessor подгружает нужную команду и выполняет ее.
Команда представляет из себя реализацию абстрактного класса `models/commands/AbstractCommand.php`, в задачу которого
входит запустить нужную команду с аргументами (запустить процесс), полученными из сообщения в очереди и
обработать вывод команды. В зависимости от того, что будет в выводе, команда может генерировать новые сообщения и
отправлять их в очередь, писать в БД и прочее. Если в течение выполнения команды или обработки сообщения было выброшено исключение,
то сообщение будет считаться доставленным (TaskProcessor оборачивает выполнение команды в try/catch, не совсем корректная 
логика но пока так). Примерная схема работы изображена на схеме.
```
      +---------------------+         +---------------------+          +---------------------+
      |                     |         |                     |          |                     |
      |   Создание задачи   +-------->+  Обработка доменов  +--------->+ Сообщение на домен  |
      |                     |         |                     |          |                     |
      +---------------------+         +---------------------+          +----------+----------+
       Веб интерфейс                                                              |
      +-------------------------------------------------------------------------------------------+
                                                                           Воркер |
                                                                                  |
                                                                                  v
      +---------------------+         +---------------------+          +----------+----------+
      |                     |         |Инициализация потомка|          | Сообщение попадает  |
+-----+ Запуск метода run() +<--------+                     +<---------+       в воркер      <-----+
|     |                     |         |   AbstractCommand   |          |   (TaskProcessor)   |     |
|     +----------+-----+----+         +---------------------+          +---------------------+     |
|                | 1   | 2  | 3                                                                    |
|                |     |    |                                                                      |
|                |     |    +-----------------------------------------------------+                |
|                |     +----------------------+                                   |                |
|                |                            |                                   |                |
|                |                            |                                   |                |
|     +----------+----------+       +---------+-------------+        +------------+----------+     |
|     | preExecute():       |       |  shell_exec           |        | postExecute():        |     |
|     | * Обработка тела    |       |  * строка             |        | * Обработка вывода    |     |
|     | сообщения из очереди|       |  должна быть          |        | команды               |     |
|     | (доп. параметры);   |       |  собрана в preExecute |        | * Генерация новых     |     |
|     | * Сборка команды    |       |                       |        | сущностей (сообщения  |     |
|     | (строка с           |       +-----------------------+        | в очередь, уведомления|     |
|     | параметрами)        |                                        | и т.д.)               |     |
|     |                     |                                        +-----------------------+     |
|     +---------------------+                                                                      |
|                                                                    +-----------------------+     |
|       +-------------------+                                        |                       |     |
|       |                   |                                        |                       |     |
+------>+ Уведомление       +---------------------------------------->     Запрос нового     +-----+
        | сервера очередей  |                                        |       сообщения       |
        | что сообщение было|                                        |                       |
        | доставлено        |                                        |                       |
        |                   |                                        |                       |
        +-------------------+                                        +-----------------------+


```
`TODO: task workflow`